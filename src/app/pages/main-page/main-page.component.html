<div class="container" appContainer>
    <div class="header">
        <app-navbar *ngIf="!previewMode"></app-navbar>
        <p *ngIf="previewMode">Zalogowano jako: {{ activeProfile.name }}</p>
    </div>
    <div class="content">
        <div class="left-side">
            <app-expenses-info 
                (enterPreviewMode)="onEnterPreviewMode(modalRef)"
                [previewMode]="previewMode"
                [monthlySum]="monthlySum"
                [date]="{fullDate: checkedDate, monthName: checkedMonth}"
                [data]="{activeProfile, previewedProfile}"
            >
            </app-expenses-info>
            <app-change-month-arrows (dateEmitter)="onReceiveDate($event)"></app-change-month-arrows>
        </div>
        <div class="right-side">
            <div class="graph">
                <div 
                    class="widget"
                    appWidget
                >
                    <p class="no-expenses-info" *ngIf="monthlyExpenses.length === 0">
                        Brak wydatków.
                    </p>
                    <div class="chart-wrap">
                        <canvas 
                            id="chart" 
                            [ngStyle]="{ 
                                visibility: monthlyExpenses.length === 0 ? 'hidden' : 'visible' 
                            }"
                        ></canvas>
                    </div>
                    <div 
                        class="chart-display"
                        [ngStyle]="{display: monthlyExpenses.length === 0 ? 'none' : 'flex'}"
                    >
                        <p (click)="onCategoryChart()"> <- </p>
                        <p (click)="onDaysInMonthChart()"> -> </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="last-expenses-list">
        <div 
            class="widget"
            appWidget
        >
            <h3>Ostatnie wydatki</h3>
            <div class="scroll">
                <p class="no-expenses-info" *ngIf="monthlyExpenses.length === 0">
                    Brak wydatków.
                </p>
                <table>
                    <tr *ngIf="monthlyExpenses.length > 0">
                        <th>Kategoria</th>
                        <th>Kwota</th>
                        <th>Data</th>
                        <th>Opis</th>
                        <th>Cykliczność</th>
                    </tr>
                    <tr *ngFor="let expense of monthlyExpenses; let i = index" title="Kliknij dwukrotnie lewym przyciskiem myszy żeby edytować dane.">
                        <td (dblclick)="onEnterEdit('category', i)" (keydown.enter)="onCloseEdit()">
                            <p *ngIf="previewMode || !previewMode && (propToEdit.length === 0 || editedIndex !== i || propToEdit !== 'category')">
                                {{ 
                                    previewMode ? previewedProfile.categories?.find(findCategory(expense))?.content 
                                    : activeProfile.categories?.find(findCategory(expense))?.content
                                }}
                            </p>
                            <select
                                *ngIf="propToEdit === 'category' && editedIndex === i && !previewMode"
                                id="category"
                                name="category"
                                (change)="onChangeProp($event)"
                            >
                                <option [value]="category.id" *ngFor="let category of activeProfile.categories">
                                    {{ category.content }}
                                </option>
                            </select>
                        </td>
                        <td (dblclick)="onEnterEdit('price', i)" (keydown.enter)="onCloseEdit()">
                            <p *ngIf="previewMode || !previewMode && (propToEdit.length === 0 || editedIndex !== i || propToEdit !== 'price')">
                                {{ expense.price + ' zł' }}
                            </p>
                            <input
                                *ngIf="propToEdit === 'price' && editedIndex === i && !previewMode"
                                type="number"
                                (keydown.enter)="onChangeProp($event)"
                            >
                        </td>
                        <td (dblclick)="onEnterEdit('date', i)" (keydown.enter)="onCloseEdit()">
                            <p *ngIf="previewMode || !previewMode && (propToEdit.length === 0 || editedIndex !== i || propToEdit !== 'date')">
                                {{ expense.date | date}}
                            </p>
                            <input
                                *ngIf="propToEdit === 'date' && editedIndex === i && !previewMode"
                                type="date"
                                (keydown.enter)="onChangeProp($event)"
                            >
                        </td>
                        <td (dblclick)="onEnterEdit('description', i)" (keydown.enter)="onCloseEdit()">
                            <p *ngIf="previewMode || !previewMode && (propToEdit.length === 0 || editedIndex !== i || propToEdit !== 'description')">
                                {{ expense.description }}
                            </p>
                            <input
                                *ngIf="propToEdit === 'description' && editedIndex === i && !previewMode"
                                type="text"
                                (keydown.enter)="onChangeProp($event)"
                            >
                        </td>
                        <td (dblclick)="onEnterEdit('renewalTime', i)" (keydown.enter)="onCloseEdit()">
                            <p *ngIf="previewMode || !previewMode && (propToEdit.length === 0 || editedIndex !== i || propToEdit !== 'renewalTime')">
                                {{ expense.renewalTime ? expense.renewalTime + ' dni' : 'Jednorazowy' }}
                            </p>
                            <div 
                                class="cyclic-input" 
                                *ngIf="propToEdit === 'renewalTime' && editedIndex === i && !previewMode"
                                (keydown.enter)="onCloseEdit()"
                            >
                                <div class="chkbx">
                                    <input 
                                        type="checkbox"
                                        id="cyclic"
                                        name="cyclic"
                                        ngModel
                                        #chkbx
                                        (change)="onChangeProp($event, 'isPeriodic')"
                                    > Cykliczny
                                </div>
                                <div class="cyclic-value">
                                    <p>Co</p>
                                    <input 
                                        type="number" 
                                        id="renewal"
                                        name="renewal"
                                        ngModel
                                        [disabled]="!chkbx.checked" 
                                        (keydown.enter)="onChangeProp($event)"
                                    >
                                    <p>dni</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<ng-template #modalRef>
    <div class="modal-container">
        <div class="modal-row">
            <h1>Wybierz profil do podglądu:</h1>
            <button (click)="onCloseModal()">
                <img src="../assets/icons/cancel.png">
            </button>
        </div>
        <div class="modal-content">
            <div 
                class="item" 
                *ngFor="let profile of loggedUser?.profiles"
                [ngClass]="{
                    active: (previewMode === false && profile.id === activeProfile.id) || (previewMode === true && profile.id === previewedProfile.id)
                }"
                (click)="onSelectProfile(profile)"
            >
                <div 
                    class="widget"
                    appWidget
                    widgetHeight="150px"
                    widgetWidth="150px"
                >
                    <img [src]="
                        profile.role === 'admin' ? '../assets/icons/admin-icon.png'
                        : '../assets/icons/user-icon.png'
                    ">
                </div>
                <p>{{ profile.name }}</p>
            </div>
        </div>
    </div>
</ng-template>